services:
  # api-gateway:
  #   container_name: api-gateway
  #   build:
  #     context: ./api-gateway
  #     dockerfile: Dockerfile
  #   ports:
  #     - 8000:8000
  #   env_file:
  #     - auth_service/.env
  #   depends_on:
  #     - ms-auth
  #   restart: always

  db-auth:
    image: postgres:latest
    container_name: db-auth
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: my_own_password_123
      POSTGRES_DB: auth_users
    volumes:
      - postgres_data_auth:/var/lib/postgresql/data
    ports:
      - 5432:5432

  ms-auth:
    container_name: ms-auth
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    ports:
      - 8001:8001
    env_file:
      - auth_service/.env
    depends_on:
      - db-auth
      - kafka-init
    restart: always

  ms-profiles:
    container_name: ms-profiles
    build:
      context: ./profiles_service
      dockerfile: Dockerfile
    ports:
      - 8002:8002
    env_file:
      - profiles_service/.env
    depends_on:
      - db-profiles
      - ms-auth
      - kafka-init
      - redis-profiles
    restart: always

  db-profiles:
    image: postgres:latest
    container_name: db-profiles
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: my_own_password_123
      POSTGRES_DB: users_profiles
    volumes:
      - postgres_data_profiles:/var/lib/postgresql/data
    ports:
      - 5433:5432

  redis-profiles:
    image: redis:7.2-alpine
    container_name: redis-profiles
    restart: unless-stopped
    ports:
      - 6379:6379
#    command: ["redis-server", "--requirepass", "my_own_password_123"]

  kafka:
    image: bitnami/kafka:latest
    container_name: kafka
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
    ports:
      - 9092:9092
      - 9094:9094

  kafka-init:
    image: bitnami/kafka:latest
    depends_on:
      - kafka
    volumes:
      - ./kafka-topics-init.sh:/kafka-topics-init.sh
    entrypoint: ["/bin/bash", "/kafka-topics-init.sh"]

volumes:
  postgres_data_auth:
    driver: local
  postgres_data_profiles:
    driver: local